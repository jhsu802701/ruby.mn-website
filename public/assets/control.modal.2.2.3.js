/**
 * @author Ryan Johnson <ryan@livepipe.net>
 * @copyright 2007 LivePipe LLC
 * @package Control.Modal
 * @license MIT
 * @url http://livepipe.net/projects/control_modal/
 * @version 2.2.2
 */
typeof Control=="undefined"&&(Control={}),Control.Modal=Class.create(),Object.extend(Control.Modal,{loaded:!1,loading:!1,loadingTimeout:!1,overlay:!1,container:!1,current:!1,ie:!1,effects:{containerFade:!1,containerAppear:!1,overlayFade:!1,overlayAppear:!1},targetRegexp:/#(.+)$/,imgRegexp:/\.(jpe?g|gif|png|tiff?)$/i,overlayStyles:{position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:9998},overlayIEStyles:{position:"absolute",top:0,left:0,zIndex:9998},disableHoverClose:!1,load:function(){if(!Control.Modal.loaded){Control.Modal.loaded=!0,Control.Modal.ie=typeof document.body.style.maxHeight=="undefined",Control.Modal.overlay=$(document.createElement("div")),Control.Modal.overlay.id="modal_overlay",Object.extend(Control.Modal.overlay.style,Control.Modal["overlay"+(Control.Modal.ie?"IE":"")+"Styles"]),Control.Modal.overlay.hide(),Control.Modal.container=$(document.createElement("div")),Control.Modal.container.id="modal_container",Control.Modal.container.hide(),Control.Modal.loading=$(document.createElement("div")),Control.Modal.loading.id="modal_loading",Control.Modal.loading.hide();var a=document.getElementsByTagName("body")[0];a.appendChild(Control.Modal.overlay),a.appendChild(Control.Modal.container),a.appendChild(Control.Modal.loading),Control.Modal.container.observe("mouseout",function(a){!Control.Modal.disableHoverClose&&Control.Modal.current&&Control.Modal.current.options.hover&&!Position.within(Control.Modal.container,Event.pointerX(a),Event.pointerY(a))&&Control.Modal.close()})}},open:function(a,b){b=b||{},b.contents||(b.contents=a);var c=new Control.Modal(!1,b);return c.open(),c},close:function(a){typeof a!="boolean"&&(a=!1),Control.Modal.current&&Control.Modal.current.close(a)},attachEvents:function(){Event.observe(window,"load",Control.Modal.load),Event.observe(window,"unload",Event.unloadCache,!1)},center:function(a){a._absolutized||(a.setStyle({position:"absolute"}),a._absolutized=!0);var b=a.getDimensions();Position.prepare();var c=Position.deltaX+Math.floor((Control.Modal.getWindowWidth()-b.width)/2),d=Position.deltaY+(Control.Modal.getWindowHeight()>b.height?Math.floor((Control.Modal.getWindowHeight()-b.height)/2):0);a.setStyle({top:b.height<=Control.Modal.getDocumentHeight()?(d!=null&&d>0?d:"0")+"px":0,left:b.width<=Control.Modal.getDocumentWidth()?(c!=null&&c>0?c:"0")+"px":0})},getWindowWidth:function(){return self.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0},getWindowHeight:function(){return self.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0},getDocumentWidth:function(){return Math.min(document.body.scrollWidth,Control.Modal.getWindowWidth())},getDocumentHeight:function(){return Math.max(document.body.scrollHeight,Control.Modal.getWindowHeight())},onKeyDown:function(a){a.keyCode==Event.KEY_ESC&&Control.Modal.close()}}),Object.extend(Control.Modal.prototype,{mode:"",html:!1,href:"",element:!1,src:!1,imageLoaded:!1,ajaxRequest:!1,initialize:function(a,b){this.element=$(a),this.options={beforeOpen:Prototype.emptyFunction,afterOpen:Prototype.emptyFunction,beforeClose:Prototype.emptyFunction,afterClose:Prototype.emptyFunction,onSuccess:Prototype.emptyFunction,onFailure:Prototype.emptyFunction,onException:Prototype.emptyFunction,beforeImageLoad:Prototype.emptyFunction,afterImageLoad:Prototype.emptyFunction,autoOpenIfLinked:!0,contents:!1,loading:!1,fade:!1,fadeDuration:.75,image:!1,imageCloseOnClick:!0,hover:!1,iframe:!1,iframeTemplate:new Template('<iframe src="#{href}" width="100%" height="100%" frameborder="0" id="#{id}"></iframe>'),evalScripts:!0,requestOptions:{},overlayDisplay:!0,overlayClassName:"",overlayCloseOnClick:!0,containerClassName:"",opacity:.3,zIndex:9998,width:null,height:null,offsetLeft:0,offsetTop:0,position:"absolute"},Object.extend(this.options,b||{});var c=!1,d=!1;this.element&&(c=Control.Modal.targetRegexp.exec(this.element.href),d=Control.Modal.imgRegexp.exec(this.element.href)),this.options.position=="mouse"&&(this.options.hover=!0);if(this.options.contents)this.mode="contents";else if(this.options.image||d)this.mode="image",this.src=this.element.href;else if(c){this.mode="named";var e=$(c[1]);this.html=e.innerHTML,e.remove(),this.href=c[1]}else this.mode=this.options.iframe?"iframe":"ajax",this.href=this.element.href;this.element&&(this.options.hover?(this.element.observe("mouseover",this.open.bind(this)),this.element.observe("mouseout",function(a){Position.within(Control.Modal.container,Event.pointerX(a),Event.pointerY(a))||this.close()}.bindAsEventListener(this))):this.element.onclick=function(a){return this.open(),Event.stop(a),!1}.bindAsEventListener(this));var f=Control.Modal.targetRegexp.exec(window.location);this.position=function(a){if(this.options.position=="absolute")Control.Modal.center(Control.Modal.container);else{var b=a&&this.options.position=="mouse"?[Event.pointerX(a),Event.pointerY(a)]:Position.cumulativeOffset(this.element);Control.Modal.container.setStyle({position:"absolute",top:b[1]+(typeof this.options.offsetTop=="function"?this.options.offsetTop():this.options.offsetTop)+"px",left:b[0]+(typeof this.options.offsetLeft=="function"?this.options.offsetLeft():this.options.offsetLeft)+"px"})}Control.Modal.ie&&Control.Modal.overlay.setStyle({height:Control.Modal.getDocumentHeight()+"px",width:Control.Modal.getDocumentWidth()+"px"})}.bind(this),this.mode=="named"&&this.options.autoOpenIfLinked&&f&&f[1]&&f[1]==this.href&&this.open()},showLoadingIndicator:function(){this.options.loading&&(Control.Modal.loadingTimeout=window.setTimeout(function(){var a=$("modal_image");a&&a.hide(),Control.Modal.loading.style.zIndex=this.options.zIndex+1,Control.Modal.loading.update('<img id="modal_loading" src="'+this.options.loading+'"/>'),Control.Modal.loading.show(),Control.Modal.center(Control.Modal.loading)}.bind(this),250))},hideLoadingIndicator:function(){if(this.options.loading){Control.Modal.loadingTimeout&&window.clearTimeout(Control.Modal.loadingTimeout);var a=$("modal_image");a&&a.show(),Control.Modal.loading.hide()}},open:function(a){if(!a&&this.notify("beforeOpen")===!1)return;Control.Modal.loaded||Control.Modal.load(),Control.Modal.close(),this.options.hover||Event.observe($(document.getElementsByTagName("body")[0]),"keydown",Control.Modal.onKeyDown),Control.Modal.current=this,this.options.hover||Control.Modal.overlay.setStyle({zIndex:this.options.zIndex,opacity:this.options.opacity}),Control.Modal.container.setStyle({zIndex:this.options.zIndex+1,width:this.options.width?(typeof this.options.width=="function"?this.options.width():this.options.width)+"px":null,height:this.options.height?(typeof this.options.height=="function"?this.options.height():this.options.height)+"px":null}),Control.Modal.ie&&!this.options.hover&&$A(document.getElementsByTagName("select")).each(function(a){a.style.visibility="hidden"}),Control.Modal.overlay.addClassName(this.options.overlayClassName),Control.Modal.container.addClassName(this.options.containerClassName);switch(this.mode){case"image":this.imageLoaded=!1,this.notify("beforeImageLoad"),this.showLoadingIndicator();var b=document.createElement("img");b.onload=function(a){this.hideLoadingIndicator(),this.update([a]),this.options.imageCloseOnClick&&$(a).observe("click",Control.Modal.close),this.position(),this.notify("afterImageLoad"),a.onload=null}.bind(this,b),b.src=this.src,b.id="modal_image";break;case"ajax":this.notify("beforeLoad");var c={method:"post",onSuccess:function(a){this.hideLoadingIndicator(),this.update(a.responseText),this.notify("onSuccess",a),this.ajaxRequest=!1}.bind(this),onFailure:function(){this.notify("onFailure")}.bind(this),onException:function(){this.notify("onException")}.bind(this)};Object.extend(c,this.options.requestOptions),this.showLoadingIndicator(),this.ajaxRequest=new Ajax.Request(this.href,c);break;case"iframe":this.update(this.options.iframeTemplate.evaluate({href:this.href,id:"modal_iframe"}));break;case"contents":this.update(typeof this.options.contents=="function"?this.options.contents():this.options.contents);break;case"named":this.update(this.html)}this.options.hover||(this.options.overlayCloseOnClick&&this.options.overlayDisplay&&Control.Modal.overlay.observe("click",Control.Modal.close),this.options.overlayDisplay&&(this.options.fade?(Control.Modal.effects.overlayFade&&Control.Modal.effects.overlayFade.cancel(),Control.Modal.effects.overlayAppear=new Effect.Appear(Control.Modal.overlay,{queue:{position:"front",scope:"Control.Modal"},to:this.options.opacity,duration:this.options.fadeDuration/2})):Control.Modal.overlay.show())),this.options.position=="mouse"&&(this.mouseHoverListener=this.position.bindAsEventListener(this),this.element.observe("mousemove",this.mouseHoverListener)),this.notify("afterOpen")},update:function(a){typeof a=="string"?Control.Modal.container.update(a):(Control.Modal.container.update(""),a.each?a.each(function(a){Control.Modal.container.appendChild(a)}):Control.Modal.container.appendChild(node)),this.options.fade?(Control.Modal.effects.containerFade&&Control.Modal.effects.containerFade.cancel(),Control.Modal.effects.containerAppear=new Effect.Appear(Control.Modal.container,{queue:{position:"end",scope:"Control.Modal"},to:1,duration:this.options.fadeDuration/2})):Control.Modal.container.show(),this.position(),Event.observe(window,"resize",this.position,!1),Event.observe(window,"scroll",this.position,!1)},close:function(a){if(!a&&this.notify("beforeClose")===!1)return;this.ajaxRequest&&this.ajaxRequest.transport.abort(),this.hideLoadingIndicator();if(this.mode=="image"){var b=$("modal_image");this.options.imageCloseOnClick&&b&&b.stopObserving("click",Control.Modal.close)}Control.Modal.ie&&!this.options.hover&&$A(document.getElementsByTagName("select")).each(function(a){a.style.visibility="visible"}),this.options.hover||Event.stopObserving(window,"keyup",Control.Modal.onKeyDown),Control.Modal.current=!1,Event.stopObserving(window,"resize",this.position,!1),Event.stopObserving(window,"scroll",this.position,!1),this.options.hover||(this.options.overlayCloseOnClick&&this.options.overlayDisplay&&Control.Modal.overlay.stopObserving("click",Control.Modal.close),this.options.overlayDisplay&&(this.options.fade?(Control.Modal.effects.overlayAppear&&Control.Modal.effects.overlayAppear.cancel(),Control.Modal.effects.overlayFade=new Effect.Fade(Control.Modal.overlay,{queue:{position:"end",scope:"Control.Modal"},from:this.options.opacity,to:0,duration:this.options.fadeDuration/2})):Control.Modal.overlay.hide())),this.options.fade?(Control.Modal.effects.containerAppear&&Control.Modal.effects.containerAppear.cancel(),Control.Modal.effects.containerFade=new Effect.Fade(Control.Modal.container,{queue:{position:"front",scope:"Control.Modal"},from:1,to:0,duration:this.options.fadeDuration/2,afterFinish:function(){Control.Modal.container.update(""),this.resetClassNameAndStyles()}.bind(this)})):(Control.Modal.container.hide(),Control.Modal.container.update(""),this.resetClassNameAndStyles()),this.options.position=="mouse"&&this.element.stopObserving("mousemove",this.mouseHoverListener),this.notify("afterClose")},resetClassNameAndStyles:function(){Control.Modal.overlay.removeClassName(this.options.overlayClassName),Control.Modal.container.removeClassName(this.options.containerClassName),Control.Modal.container.setStyle({height:null,width:null,top:null,left:null})},notify:function(a){try{if(this.options[a])return[this.options[a].apply(this.options[a],$A(arguments).slice(1))]}catch(b){if(b!=$break)throw b;return!1}}}),typeof Object.Event!="undefined"&&Object.Event.extend(Control.Modal),Control.Modal.attachEvents()