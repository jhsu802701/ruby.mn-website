/**
 * @author Ryan Johnson <ryan@livepipe.net>
 * @copyright 2007 LivePipe LLC
 * @package Control.Modal
 * @license MIT
 * @url http://livepipe.net/projects/control_modal/
 * @version 2.2.2
 */
"undefined"==typeof Control&&(Control={}),Control.Modal=Class.create(),Object.extend(Control.Modal,{loaded:!1,loading:!1,loadingTimeout:!1,overlay:!1,container:!1,current:!1,ie:!1,effects:{containerFade:!1,containerAppear:!1,overlayFade:!1,overlayAppear:!1},targetRegexp:/#(.+)$/,imgRegexp:/\.(jpe?g|gif|png|tiff?)$/i,overlayStyles:{position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:9998},overlayIEStyles:{position:"absolute",top:0,left:0,zIndex:9998},disableHoverClose:!1,load:function(){if(!Control.Modal.loaded){Control.Modal.loaded=!0,Control.Modal.ie=!("undefined"!=typeof document.body.style.maxHeight),Control.Modal.overlay=$(document.createElement("div")),Control.Modal.overlay.id="modal_overlay",Object.extend(Control.Modal.overlay.style,Control.Modal["overlay"+(Control.Modal.ie?"IE":"")+"Styles"]),Control.Modal.overlay.hide(),Control.Modal.container=$(document.createElement("div")),Control.Modal.container.id="modal_container",Control.Modal.container.hide(),Control.Modal.loading=$(document.createElement("div")),Control.Modal.loading.id="modal_loading",Control.Modal.loading.hide();var o=document.getElementsByTagName("body")[0];o.appendChild(Control.Modal.overlay),o.appendChild(Control.Modal.container),o.appendChild(Control.Modal.loading),Control.Modal.container.observe("mouseout",function(o){!Control.Modal.disableHoverClose&&Control.Modal.current&&Control.Modal.current.options.hover&&!Position.within(Control.Modal.container,Event.pointerX(o),Event.pointerY(o))&&Control.Modal.close()})}},open:function(o,t){t=t||{},t.contents||(t.contents=o);var e=new Control.Modal(!1,t);return e.open(),e},close:function(o){"boolean"!=typeof o&&(o=!1),Control.Modal.current&&Control.Modal.current.close(o)},attachEvents:function(){Event.observe(window,"load",Control.Modal.load),Event.observe(window,"unload",Event.unloadCache,!1)},center:function(o){o._absolutized||(o.setStyle({position:"absolute"}),o._absolutized=!0);var t=o.getDimensions();Position.prepare();var e=Position.deltaX+Math.floor((Control.Modal.getWindowWidth()-t.width)/2),n=Position.deltaY+(Control.Modal.getWindowHeight()>t.height?Math.floor((Control.Modal.getWindowHeight()-t.height)/2):0);o.setStyle({top:t.height<=Control.Modal.getDocumentHeight()?(null!=n&&n>0?n:"0")+"px":0,left:t.width<=Control.Modal.getDocumentWidth()?(null!=e&&e>0?e:"0")+"px":0})},getWindowWidth:function(){return self.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0},getWindowHeight:function(){return self.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0},getDocumentWidth:function(){return Math.min(document.body.scrollWidth,Control.Modal.getWindowWidth())},getDocumentHeight:function(){return Math.max(document.body.scrollHeight,Control.Modal.getWindowHeight())},onKeyDown:function(o){o.keyCode==Event.KEY_ESC&&Control.Modal.close()}}),Object.extend(Control.Modal.prototype,{mode:"",html:!1,href:"",element:!1,src:!1,imageLoaded:!1,ajaxRequest:!1,initialize:function(o,t){this.element=$(o),this.options={beforeOpen:Prototype.emptyFunction,afterOpen:Prototype.emptyFunction,beforeClose:Prototype.emptyFunction,afterClose:Prototype.emptyFunction,onSuccess:Prototype.emptyFunction,onFailure:Prototype.emptyFunction,onException:Prototype.emptyFunction,beforeImageLoad:Prototype.emptyFunction,afterImageLoad:Prototype.emptyFunction,autoOpenIfLinked:!0,contents:!1,loading:!1,fade:!1,fadeDuration:.75,image:!1,imageCloseOnClick:!0,hover:!1,iframe:!1,iframeTemplate:new Template('<iframe src="#{href}" width="100%" height="100%" frameborder="0" id="#{id}"></iframe>'),evalScripts:!0,requestOptions:{},overlayDisplay:!0,overlayClassName:"",overlayCloseOnClick:!0,containerClassName:"",opacity:.3,zIndex:9998,width:null,height:null,offsetLeft:0,offsetTop:0,position:"absolute"},Object.extend(this.options,t||{});var e=!1,n=!1;if(this.element&&(e=Control.Modal.targetRegexp.exec(this.element.href),n=Control.Modal.imgRegexp.exec(this.element.href)),"mouse"==this.options.position&&(this.options.hover=!0),this.options.contents)this.mode="contents";else if(this.options.image||n)this.mode="image",this.src=this.element.href;else if(e){this.mode="named";var i=$(e[1]);this.html=i.innerHTML,i.remove(),this.href=e[1]}else this.mode=this.options.iframe?"iframe":"ajax",this.href=this.element.href;this.element&&(this.options.hover?(this.element.observe("mouseover",this.open.bind(this)),this.element.observe("mouseout",function(o){Position.within(Control.Modal.container,Event.pointerX(o),Event.pointerY(o))||this.close()}.bindAsEventListener(this))):this.element.onclick=function(o){return this.open(),Event.stop(o),!1}.bindAsEventListener(this));var l=Control.Modal.targetRegexp.exec(window.location);this.position=function(o){if("absolute"==this.options.position)Control.Modal.center(Control.Modal.container);else{var t=o&&"mouse"==this.options.position?[Event.pointerX(o),Event.pointerY(o)]:Position.cumulativeOffset(this.element);Control.Modal.container.setStyle({position:"absolute",top:t[1]+("function"==typeof this.options.offsetTop?this.options.offsetTop():this.options.offsetTop)+"px",left:t[0]+("function"==typeof this.options.offsetLeft?this.options.offsetLeft():this.options.offsetLeft)+"px"})}Control.Modal.ie&&Control.Modal.overlay.setStyle({height:Control.Modal.getDocumentHeight()+"px",width:Control.Modal.getDocumentWidth()+"px"})}.bind(this),"named"==this.mode&&this.options.autoOpenIfLinked&&l&&l[1]&&l[1]==this.href&&this.open()},showLoadingIndicator:function(){this.options.loading&&(Control.Modal.loadingTimeout=window.setTimeout(function(){var o=$("modal_image");o&&o.hide(),Control.Modal.loading.style.zIndex=this.options.zIndex+1,Control.Modal.loading.update('<img id="modal_loading" src="'+this.options.loading+'"/>'),Control.Modal.loading.show(),Control.Modal.center(Control.Modal.loading)}.bind(this),250))},hideLoadingIndicator:function(){if(this.options.loading){Control.Modal.loadingTimeout&&window.clearTimeout(Control.Modal.loadingTimeout);var o=$("modal_image");o&&o.show(),Control.Modal.loading.hide()}},open:function(o){if(o||this.notify("beforeOpen")!==!1){switch(Control.Modal.loaded||Control.Modal.load(),Control.Modal.close(),this.options.hover||Event.observe($(document.getElementsByTagName("body")[0]),"keydown",Control.Modal.onKeyDown),Control.Modal.current=this,this.options.hover||Control.Modal.overlay.setStyle({zIndex:this.options.zIndex,opacity:this.options.opacity}),Control.Modal.container.setStyle({zIndex:this.options.zIndex+1,width:this.options.width?("function"==typeof this.options.width?this.options.width():this.options.width)+"px":null,height:this.options.height?("function"==typeof this.options.height?this.options.height():this.options.height)+"px":null}),Control.Modal.ie&&!this.options.hover&&$A(document.getElementsByTagName("select")).each(function(o){o.style.visibility="hidden"}),Control.Modal.overlay.addClassName(this.options.overlayClassName),Control.Modal.container.addClassName(this.options.containerClassName),this.mode){case"image":this.imageLoaded=!1,this.notify("beforeImageLoad"),this.showLoadingIndicator();var t=document.createElement("img");t.onload=function(o){this.hideLoadingIndicator(),this.update([o]),this.options.imageCloseOnClick&&$(o).observe("click",Control.Modal.close),this.position(),this.notify("afterImageLoad"),o.onload=null}.bind(this,t),t.src=this.src,t.id="modal_image";break;case"ajax":this.notify("beforeLoad");var e={method:"post",onSuccess:function(o){this.hideLoadingIndicator(),this.update(o.responseText),this.notify("onSuccess",o),this.ajaxRequest=!1}.bind(this),onFailure:function(){this.notify("onFailure")}.bind(this),onException:function(){this.notify("onException")}.bind(this)};Object.extend(e,this.options.requestOptions),this.showLoadingIndicator(),this.ajaxRequest=new Ajax.Request(this.href,e);break;case"iframe":this.update(this.options.iframeTemplate.evaluate({href:this.href,id:"modal_iframe"}));break;case"contents":this.update("function"==typeof this.options.contents?this.options.contents():this.options.contents);break;case"named":this.update(this.html)}this.options.hover||(this.options.overlayCloseOnClick&&this.options.overlayDisplay&&Control.Modal.overlay.observe("click",Control.Modal.close),this.options.overlayDisplay&&(this.options.fade?(Control.Modal.effects.overlayFade&&Control.Modal.effects.overlayFade.cancel(),Control.Modal.effects.overlayAppear=new Effect.Appear(Control.Modal.overlay,{queue:{position:"front",scope:"Control.Modal"},to:this.options.opacity,duration:this.options.fadeDuration/2})):Control.Modal.overlay.show())),"mouse"==this.options.position&&(this.mouseHoverListener=this.position.bindAsEventListener(this),this.element.observe("mousemove",this.mouseHoverListener)),this.notify("afterOpen")}},update:function(o){"string"==typeof o?Control.Modal.container.update(o):(Control.Modal.container.update(""),o.each?o.each(function(o){Control.Modal.container.appendChild(o)}):Control.Modal.container.appendChild(node)),this.options.fade?(Control.Modal.effects.containerFade&&Control.Modal.effects.containerFade.cancel(),Control.Modal.effects.containerAppear=new Effect.Appear(Control.Modal.container,{queue:{position:"end",scope:"Control.Modal"},to:1,duration:this.options.fadeDuration/2})):Control.Modal.container.show(),this.position(),Event.observe(window,"resize",this.position,!1),Event.observe(window,"scroll",this.position,!1)},close:function(o){if(o||this.notify("beforeClose")!==!1){if(this.ajaxRequest&&this.ajaxRequest.transport.abort(),this.hideLoadingIndicator(),"image"==this.mode){var t=$("modal_image");this.options.imageCloseOnClick&&t&&t.stopObserving("click",Control.Modal.close)}Control.Modal.ie&&!this.options.hover&&$A(document.getElementsByTagName("select")).each(function(o){o.style.visibility="visible"}),this.options.hover||Event.stopObserving(window,"keyup",Control.Modal.onKeyDown),Control.Modal.current=!1,Event.stopObserving(window,"resize",this.position,!1),Event.stopObserving(window,"scroll",this.position,!1),this.options.hover||(this.options.overlayCloseOnClick&&this.options.overlayDisplay&&Control.Modal.overlay.stopObserving("click",Control.Modal.close),this.options.overlayDisplay&&(this.options.fade?(Control.Modal.effects.overlayAppear&&Control.Modal.effects.overlayAppear.cancel(),Control.Modal.effects.overlayFade=new Effect.Fade(Control.Modal.overlay,{queue:{position:"end",scope:"Control.Modal"},from:this.options.opacity,to:0,duration:this.options.fadeDuration/2})):Control.Modal.overlay.hide())),this.options.fade?(Control.Modal.effects.containerAppear&&Control.Modal.effects.containerAppear.cancel(),Control.Modal.effects.containerFade=new Effect.Fade(Control.Modal.container,{queue:{position:"front",scope:"Control.Modal"},from:1,to:0,duration:this.options.fadeDuration/2,afterFinish:function(){Control.Modal.container.update(""),this.resetClassNameAndStyles()}.bind(this)})):(Control.Modal.container.hide(),Control.Modal.container.update(""),this.resetClassNameAndStyles()),"mouse"==this.options.position&&this.element.stopObserving("mousemove",this.mouseHoverListener),this.notify("afterClose")}},resetClassNameAndStyles:function(){Control.Modal.overlay.removeClassName(this.options.overlayClassName),Control.Modal.container.removeClassName(this.options.containerClassName),Control.Modal.container.setStyle({height:null,width:null,top:null,left:null})},notify:function(o){try{if(this.options[o])return[this.options[o].apply(this.options[o],$A(arguments).slice(1))]}catch(t){if(t!=$break)throw t;return!1}}}),"undefined"!=typeof Object.Event&&Object.Event.extend(Control.Modal),Control.Modal.attachEvents();